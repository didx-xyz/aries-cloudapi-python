<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Issuing a credential to a Holder - DIDx-Cloud</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">DIDx-Cloud</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="5-issuing-a-credential"><a class="header" href="#5-issuing-a-credential">5: Issuing a Credential</a></h1>
<h2 id="now-the-issuer-issues-credentials"><a class="header" href="#now-the-issuer-issues-credentials">Now the Issuer issues credentials</a></h2>
<p>Now that a connection has been made between the <code>Issuer</code> and the <code>Holder</code>, the <code>Issuer</code> can send the credential to the
<code>Holder</code> using the <code>connection_id</code> from the <code>Issuer's</code> perspective.</p>
<blockquote>
<p>Again both tenants can listen for events on the topic: <code>credentials</code></p>
</blockquote>
<h3 id="issuing-a-non-revocable-credential"><a class="header" href="#issuing-a-non-revocable-credential">Issuing a Non-Revocable Credential</a></h3>
<p>To issue a non-revocable credential, the issuer needs to send a POST request to the appropriate endpoint.
Below is an example of how to issue a non-revocable credential:</p>
<pre><code class="language-bash">curl -X 'POST' \
  'http://cloudapi.127.0.0.1.nip.io/tenant/v1/issuer/credentials' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -H 'x-api-key: tenant.&lt;Issuer token&gt;' \
  -d '{
  "type": "indy",
  "indy_credential_detail": {
    "credential_definition_id": "QrHj82kaE61jnB5451zvvG:3:CL:12:Demo Person",
    "attributes": {
      "Name": "Alice",
      "Surname": "Holder",
      "Age": "25"
    }
  },
  "connection_id": "c78f9423-370e-4800-a48e-962456083943"
}'
</code></pre>
<p>Response:</p>
<pre><code class="language-json">{
  "attributes": {
    "Name": "Alice",
    "Surname": "Holder",
    "Age": "25"
  },
  "connection_id": "c78f9423-370e-4800-a48e-962456083943",
  "created_at": "2023-11-20T09:59:29.820002Z",
  "credential_definition_id": "QrHj82kaE61jnB5451zvvG:3:CL:12:Demo Person",
  "credential_exchange_id": "v2-f126edb7-1ac1-43a3-bf1f-60b8feae4701",
  "did": null,
  "error_msg": null,
  "role": "issuer",
  "schema_id": "FS9J6WZ6KVxwy5eGH32CgM:2:Person:0.1.0",
  "state": "offer-sent",
  "thread_id": "9ceeb941-4ebd-42ec-9ffc-ea0b7fe39722",
  "type": "indy",
  "updated_at": "2023-11-20T09:59:29.820002Z"
}
</code></pre>
<p>As you can see from the state, an offer has now been sent, and needs to be
accepted/requested by the holder.</p>
<blockquote>
<p>Note that the issuer will now have what's called a <em>credential exchange record</em> in state: offer-sent.
<em>Pending</em> exchange records can be viewed by calling <code>GET /v1/issuer/credentials</code>, and <em>completed</em>
credential exchange records are deleted by default, but can be preserved by adding an optional
<code>save_exchange_record=True</code> field to the request.</p>
</blockquote>
<h3 id="issuing-a-revocable-credential"><a class="header" href="#issuing-a-revocable-credential">Issuing a Revocable Credential</a></h3>
<p>Credentials that support revocation are issued in the same way as described above, but there is additional information
that the issuer needs to keep track of.</p>
<p>There is a webhook event topic that an issuer can subscribe to called <code>"issuer_cred_rev"</code>. The <code>"issuer_cred_rev"</code>
event has information on the issued credential and how it is connected to the revocation registries and some metadata.</p>
<p>This event will fire under two circumstances:</p>
<ul>
<li>Once a credential (with revocation support) is issued.</li>
<li>And when a credential is revoked.</li>
</ul>
<p>The state of the event will correspond with these events, i.e. first it will be <strong>"issued"</strong> and after revocation it
will be <strong>"revoked"</strong>.</p>
<p>Let's take a look at an example event:</p>
<pre><code class="language-json">{
  "wallet_id": "5df42bab-6719-4c8a-a615-8086435d4de4",
  "topic": "issuer_cred_rev",
  "origin": "tenant faber",
  "group_id": "GroupA",
  "payload": {
    "created_at": "2024-04-30T08:51:18.177543Z",
    "cred_def_id": "QrMaE11MnC6zjKNY1pxbq8:3:CL:8:Epic",
    "cred_ex_id": "af4bad3f-3fcc-47ab-85e6-24224dcb2779",
    "cred_ex_version": "2",
    "cred_rev_id": "2",
    "record_id": "57bd9c72-fa29-4f65-bd89-4e241471073a",
    "rev_reg_id": "QrMaE11MnC6zjKNY1pxbq8:4:QrMaE11MnC6zjKNY1pxbq8:3:CL:8:Epic:CL_ACCUM:53462552-d716-4b0b-8b5c-914a3574d2c4",
    "state": "issued",
    "updated_at": "2024-04-30T08:51:18.177543Z"
  }
}
</code></pre>
<p>Taking a look at the payload, there are a few fields we are interested in:</p>
<ul>
<li><code>"cred_def_id"</code> or <strong>credential definition id</strong>: The same id the issuer gets when creating a credential definition
(also used when issuing credentials).</li>
<li><code>"cred_ex_id"</code> or <strong>credential exchange id</strong>: This is the same exchange id that can be found in the credential
exchange record.</li>
<li><code>"cred_rev_id"</code> or <strong>credential revocation id</strong>: This is the id that ties the credential to the revocation registry.</li>
<li><code>"rev_reg_id"</code> or <strong>revocation registry id</strong>: This is the id of the revocation registry the credential was
issued against.</li>
</ul>
<p>The <code>"issuer_cred_rev"</code> event is not the only place this data is available. Under the issuer API,
there is an endpoint: <code>GET /v1/issuer/credentials/revocation/record</code>.
This endpoint will return the payload object of the <code>"issuer_cred_rev"</code> event:</p>
<pre><code class="language-json">{
  "created_at": "2024-04-30T08:51:18.177543Z",
  "cred_def_id": "QrMaE11MnC6zjKNY1pxbq8:3:CL:8:Epic",
  "cred_ex_id": "af4bad3f-3fcc-47ab-85e6-24224dcb2779",
  "cred_ex_version": "2",
  "cred_rev_id": "2",
  "record_id": "57bd9c72-fa29-4f65-bd89-4e241471073a",
  "rev_reg_id": "QrMaE11MnC6zjKNY1pxbq8:4:QrMaE11MnC6zjKNY1pxbq8:3:CL:8:Epic:CL_ACCUM:53462552-d716-4b0b-8b5c-914a3574d2c4",
  "state": "issued",
  "updated_at": "2024-04-30T08:51:18.177543Z"
}
</code></pre>
<p>This endpoint has three query parameters:</p>
<ul>
<li><code>"credential_exchange_id"</code></li>
<li><code>"credential_revocation_id"</code></li>
<li><code>"revocation_registry_id"</code></li>
</ul>
<p>If <code>"credential_exchange_id"</code> is not provided, both the <code>"credential_revocation_id"</code> and <code>"revocation_registry_id"</code>
must be provided.</p>
<p>So with the <code>"credential_exchange_id"</code> (from the credential exchange record), an issuer can get the relevant data
needed to revoke the credential associated with the exchange id.</p>
<blockquote>
<p>[!NOTE] Issuers take note:
The <em>most</em> important thing the issuer needs to keep track of is how their credential exchange ids map to
credentials they have issued to holders. Without knowing how their exchange ids map to their holders,
they won't know which credential to revoke.</p>
</blockquote>
<h2 id="holder-requests-credential"><a class="header" href="#holder-requests-credential">Holder requests credential</a></h2>
<p>Now the <code>Holder</code> needs to respond to the credential sent to them. Below the <code>Holder</code> is getting all their connections.
We are doing this to get the <code>connection_id</code> of the connection to the issuer.
This <code>connection_id</code> can also be gotten from the <code>SSE events</code>.</p>
<pre><code class="language-bash">curl -X 'GET' \
  'http://cloudapi.127.0.0.1.nip.io/tenant/v1/connections' \
  -H 'accept: application/json' \
  -H 'x-api-key: tenant.&lt;Holder token&gt;'
</code></pre>
<p>Response:</p>
<pre><code class="language-json">[
  {
    "alias": "Holder &lt;&gt; Issuer",
    "connection_id": "ac3b0d56-eb33-408a-baeb-0370164d47ae",
    "connection_protocol": "connections/1.0",
    "created_at": "2023-11-20T09:56:41.437966Z",
    "error_msg": null,
    "invitation_key": "91ZNSpDgVoV12kHcmUqyp1JmGeKE7oGi9NFd2WMzKt4X",
    "invitation_mode": "once",
    "invitation_msg_id": "6a86e6c7-af25-4e5d-87fe-b42f559b13b9",
    "my_did": "MYhLew4uq58mou8SCTNFYp",
    "state": "completed",
    "their_did": "6wMwbinRJ5XKyBJKm7P5av",
    "their_label": "Demo Issuer",
    "their_public_did": null,
    "their_role": "inviter",
    "updated_at": "2023-11-20T09:56:41.656141Z"
  }
]
</code></pre>
<p>Note the <code>connection_id</code> in the above response.</p>
<p>The <code>Holder</code> can then find the credentials offered to them on this <code>connection_id</code> by calling <code>/v1/issuer/credentials</code>
with the optional <code>connection_id</code> query parameter:</p>
<pre><code class="language-bash">curl -X 'GET' \
  'http://cloudapi.127.0.0.1.nip.io/tenant/v1/issuer/credentials?connection_id=ac3b0d56-eb33-408a-baeb-0370164d47ae' \
  -H 'accept: application/json' \
  -H 'x-api-key: tenant.&lt;Holder token&gt;'
</code></pre>
<p>Response:</p>
<pre><code class="language-json">[
  {
    "attributes": {
      "Name": "Alice",
      "Surname": "Holder",
      "Age": "25"
    },
    "connection_id": "ac3b0d56-eb33-408a-baeb-0370164d47ae",
    "created_at": "2023-11-20T09:59:29.868946Z",
    "credential_definition_id": "QrHj82kaE61jnB5451zvvG:3:CL:12:Demo Person",
    "credential_exchange_id": "v2-c492cec7-2f2d-4d5f-b839-b57dcd8f8eee",
    "did": null,
    "error_msg": null,
    "role": "holder",
    "schema_id": "FS9J6WZ6KVxwy5eGH32CgM:2:Person:0.1.0",
    "state": "offer-received",
    "thread_id": "9ceeb941-4ebd-42ec-9ffc-ea0b7fe39722",
    "type": "indy",
    "updated_at": "2023-11-20T09:59:29.868946Z"
  }
]
</code></pre>
<p>Note the <code>credential_exchange_id</code> and <code>state: offer-received</code>. Additionally, note that the holder and the issuer have
different <code>credential_exchange_id</code> references for the same credential exchange interaction.</p>
<p>The <code>Holder</code> can now request the credential, using the <code>credential_exchange_id</code> from the above response,
by calling <code>/v1/issuer/credentials/{credential_exchange_id}/request</code>:</p>
<pre><code class="language-bash">curl -X 'POST' \
  'http://cloudapi.127.0.0.1.nip.io/tenant/v1/issuer/credentials/v2-c492cec7-2f2d-4d5f-b839-b57dcd8f8eee/request' \
  -H 'accept: application/json' \
  -H 'x-api-key: tenant.&lt;Holder token&gt;' \
  -d ''
</code></pre>
<p>Response:</p>
<pre><code class="language-json">{
  "attributes": {
    "Name": "Alice",
    "Surname": "Holder",
    "Age": "25"
  },
  "connection_id": "ac3b0d56-eb33-408a-baeb-0370164d47ae",
  "created_at": "2023-11-20T09:59:29.868946Z",
  "credential_definition_id": "QrHj82kaE61jnB5451zvvG:3:CL:12:Demo Person",
  "credential_exchange_id": "v2-c492cec7-2f2d-4d5f-b839-b57dcd8f8eee",
  "did": null,
  "error_msg": null,
  "role": "holder",
  "schema_id": "FS9J6WZ6KVxwy5eGH32CgM:2:Person:0.1.0",
  "state": "request-sent",
  "thread_id": "9ceeb941-4ebd-42ec-9ffc-ea0b7fe39722",
  "type": "indy",
  "updated_at": "2023-11-20T10:02:02.708045Z"
}
</code></pre>
<p>The holder request has been sent, and an automated workflow will transition the credential to
being stored in the holder's wallet.</p>
<p>We can listen on SSE and wait for <code>state</code> to be <code>done</code> on the <code>topic</code>: <code>credentials</code></p>
<pre><code class="language-json">  {
    "wallet_id": "7bb24cc8-2e56-4326-9020-7870ad67b257",
    "topic": "credentials",
    "origin": "multitenant",
    "payload": {
      "attributes": null,
      "connection_id": "ac3b0d56-eb33-408a-baeb-0370164d47ae",
      "created_at": "2023-11-20T09:59:29.868946Z",
      "credential_definition_id": "QrHj82kaE61jnB5451zvvG:3:CL:12:Demo Person",
      "credential_exchange_id": "v2-c492cec7-2f2d-4d5f-b839-b57dcd8f8eee",
      "did": null,
      "error_msg": null,
      "role": "holder",
      "schema_id": "FS9J6WZ6KVxwy5eGH32CgM:2:Person:0.1.0",
      "state": "done",
      "thread_id": "9ceeb941-4ebd-42ec-9ffc-ea0b7fe39722",
      "type": "indy",
      "updated_at": "2023-11-20T10:02:03.043100Z"
    }
  }
</code></pre>
<p>Once the state is done, the credential will be in the <code>Holder</code>'s wallet. We can list the credential in
the wallet by doing the following call as the <code>Holder</code>:</p>
<pre><code class="language-bash">curl -X 'GET' \
  'http://cloudapi.127.0.0.1.nip.io/tenant/v1/wallet/credentials' \
  -H 'accept: application/json' \
  -H 'x-api-key: tenant.&lt;Holder token&gt;'
</code></pre>
<p>Response:</p>
<pre><code class="language-json">{
  "results": [
    {
      "attrs": {
        "Surname": "Holder",
        "Name": "Alice",
        "Age": "25"
      },
      "cred_def_id": "QrHj82kaE61jnB5451zvvG:3:CL:12:Demo Person",
      "cred_rev_id": null,
      "referent": "86dfb6ef-1ff5-41fd-977b-092a1d97e20b",
      "rev_reg_id": null,
      "schema_id": "FS9J6WZ6KVxwy5eGH32CgM:2:Person:0.1.0"
    }
  ]
}
</code></pre>
<blockquote>
<p>Note: the credential has no reference to a <code>credential_exchange_id</code>. In the wallet context, the <code>referent</code>
is the credential id, and is different from the <code>credential_exchange_id</code> used during the credential exchange.</p>
</blockquote>
<p>Hooray! ðŸ¥³ðŸŽ‰ The holder now has a credential!</p>
<p>Next: <a href="6.%20Create%20Connection%20with%20Verifier.html">Create connection with Verifier</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../examples/4. Create Connection with Issuer.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../examples/6. Create Connection with Verifier.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../examples/4. Create Connection with Issuer.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../examples/6. Create Connection with Verifier.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </div>
    </body>
</html>
